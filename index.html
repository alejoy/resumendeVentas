<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ohana Ventas - Resumen</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-zone:hover, .upload-zone.dragover {
            background: #eef0ff;
            border-color: #764ba2;
            transform: translateY(-2px);
        }
        .upload-zone input { display: none; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            opacity: 0.9;
            font-size: 0.9em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        tr:hover {
            background: #f8f9ff;
        }
        .product-name {
            font-weight: 600;
            color: #333;
        }
        .product-meta {
            font-size: 0.85em;
            color: #666;
            margin-top: 4px;
        }
        .quantity-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
        }
        .error-row {
            background: #fff3cd !important;
        }
        .hidden { display: none; }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 20px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .filters {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .filter-btn.active, .filter-btn:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåø Ohana Ventas</h1>
        <p class="subtitle">Sistema de resumen de ventas - An√°lisis inteligente de productos</p>
        
        <div class="upload-zone" id="dropZone">
            <input type="file" id="fileInput" accept=".xlsx,.xls" />
            <div style="font-size: 3em; margin-bottom: 15px;">üìÅ</div>
            <h3>Arrastra tu archivo Excel aqu√≠</h3>
            <p style="color: #666; margin-top: 10px;">o haz clic para seleccionar</p>
        </div>

        <div id="results" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalSales">0</div>
                    <div class="stat-label">Total Ventas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-label">Productos Vendidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniqueProducts">0</div>
                    <div class="stat-label">Productos Distintos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingOrders">0</div>
                    <div class="stat-label">√ìrdenes Pendientes</div>
                </div>
            </div>

            <div class="filters">
                <button class="filter-btn active" onclick="filterStatus('all')">Todas</button>
                <button class="filter-btn" onclick="filterStatus('Finalizado')">Finalizadas</button>
                <button class="filter-btn" onclick="filterStatus('Pendiente')">Pendientes</button>
            </div>

            <table id="salesTable">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Variedad/Detalle</th>
                        <th>Cantidad Total</th>
                        <th>Unidades</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>

            <button class="btn" onclick="downloadCSV()">üì• Descargar CSV</button>
            <button class="btn" onclick="location.reload()" style="margin-left: 10px; background: #666;">üîÑ Nuevo Archivo</button>
        </div>
    </div>

    <script>
        let salesData = [];
        let currentFilter = 'all';

        // Drag and drop handlers
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        function handleFile(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    processData(jsonData);
                } catch (error) {
                    alert('Error al procesar el archivo: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // üîß PARSER MEJORADO - Maneja par√©ntesis anidados
        function parseProductString(productStr) {
            const products = [];
            // Separar por comas pero respetar par√©ntesis
            const items = splitRespectingParentheses(productStr);
            
            items.forEach(item => {
                item = item.trim();
                if (!item) return;

                // Patr√≥n: Cantidad x Nombre (Variedad) (Peso: ...) (SKU: ...)
                // Maneja par√©ntesis anidados en el nombre
                const match = item.match(/^(\d+)x\s+(.+)$/);
                if (!match) {
                    products.push({
                        raw: item,
                        quantity: 1,
                        name: item,
                        variety: '',
                        weight: '',
                        sku: '',
                        error: true
                    });
                    return;
                }

                const quantity = parseInt(match[1]);
                const details = match[2].trim();
                
                // Extraer componentes considerando par√©ntesis anidados
                const parsed = extractComponents(details);
                
                products.push({
                    raw: item,
                    quantity: quantity,
                    name: parsed.name,
                    variety: parsed.variety,
                    weight: parsed.weight,
                    sku: parsed.sku,
                    error: false
                });
            });
            
            return products;
        }
        // Separar por comas respetando par√©ntesis anidados
        function splitRespectingParentheses(str) {
            const result = [];
            let current = '';
            let depth = 0;
            
            for (let char of str) {
                if (char === '(') depth++;
                else if (char === ')') depth--;
                else if (char === ',' && depth === 0) {
                    result.push(current);
                    current = '';
                    continue;
                }
                current += char;
            }
            if (current.trim()) result.push(current);
            return result;
        }

        // Extraer componentes del producto
        function extractComponents(details) {
            const result = {
                name: details,
                variety: '',
                weight: '',
                sku: ''
            };

            // Extraer SKU
            const skuMatch = details.match(/\(SKU:\s*([^)]+)\)/);
            if (skuMatch) {
                result.sku = skuMatch[1].trim();
                details = details.replace(skuMatch[0], '').trim();
            }

            // Extraer Peso
            const weightMatch = details.match(/\(Peso:\s*([^)]+)\)/);
            if (weightMatch) {
                result.weight = weightMatch[1].trim();
                details = details.replace(weightMatch[0], '').trim();
            }

            // Extraer Variedad (lo que queda entre par√©ntesis al final)
            const varietyMatch = details.match(/\(Variedad:\s*([^)]+)\)/);
            if (varietyMatch) {
                result.variety = varietyMatch[1].trim();
                details = details.replace(varietyMatch[0], '').trim();
            }

            // El nombre base es lo que queda
            // Limpiar par√©ntesis residuales como (sin azucar)
            const nameMatch = details.match(/^([^(]+)/);
            if (nameMatch) {
                result.name = nameMatch[1].trim();
                // Buscar descriptores entre par√©ntesis que no sean metadata
                const extraMatch = details.match(/\(([^)]+)\)/g);
                if (extraMatch && !result.variety) {
                    result.variety = extraMatch.map(m => m.slice(1, -1)).join(', ');
                }
            }

            return result;
        }

        function processData(data) {
            salesData = [];
            const headers = data[0];
            
            // Encontrar √≠ndices de columnas importantes
            const productCol = headers.findIndex(h => h && h.toString().includes('Productos'));
            const statusCol = headers.findIndex(h => h && h.toString().includes('Pago'));
            const dateCol = headers.findIndex(h => h && h.toString().includes('Fecha'));
            
            for (let i = 2; i < data.length; i++) {
                const row = data[i];
                if (!row[productCol]) continue;

                const products = parseProductString(row[productCol].toString());
                const status = row[statusCol] || 'Desconocido';
                const date = row[dateCol] || '';

                products.forEach(prod => {
                    salesData.push({
                        ...prod,
                        orderStatus: status,
                        date: date,
                        rowIndex: i
                    });
                });
            }

            displayResults();
        }

        function displayResults() {
            document.getElementById('dropZone').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');

            // Calcular estad√≠sticas
            const totalSales = salesData.length;
            const totalProducts = salesData.reduce((sum, p) => sum + p.quantity, 0);
            const pendingOrders = salesData.filter(p => p.orderStatus === 'Pendiente').length;
            
            // Agrupar por producto para contar √∫nicos
            const productMap = new Map();
            salesData.forEach(p => {
                const key = `${p.name}|${p.variety}|${p.weight}`;
                if (!productMap.has(key)) {
                    productMap.set(key, { ...p, totalQty: 0 });
                }
                productMap.get(key).totalQty += p.quantity;
            });

            document.getElementById('totalSales').textContent = totalSales;
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('uniqueProducts').textContent = productMap.size;
            document.getElementById('pendingOrders').textContent = pendingOrders;

            renderTable(Array.from(productMap.values()));
        }

        function renderTable(products) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            // Filtrar si es necesario
            let filtered = products;
            if (currentFilter !== 'all') {
                const statusMap = {
                    'Finalizado': 'Finalizado',
                    'Pendiente': 'Pendiente'
                };
                // Nota: Necesitar√≠amos re-agregar l√≥gica de filtro por orden individual
            }

            // Ordenar por cantidad
            filtered.sort((a, b) => b.totalQty - a.totalQty);

            filtered.forEach(p => {
                const row = document.createElement('tr');
                if (p.error) row.classList.add('error-row');
                
                row.innerHTML = `
                    <td>
                        <div class="product-name">${escapeHtml(p.name)}</div>
                        ${p.error ? '<span style="color: orange; font-size: 0.8em;">‚ö†Ô∏è Parseo manual</span>' : ''}
                    </td>
                    <td>
                        ${p.variety ? `<div>Var: ${escapeHtml(p.variety)}</div>` : ''}
                        ${p.weight ? `<div class="product-meta">Peso: ${escapeHtml(p.weight)}</div>` : ''}
                    </td>
                    <td><span class="quantity-badge">${p.totalQty}</span></td>
                    <td>${p.sku || '-'}</td>
                    <td>${getStatusBadge(p.orderStatus)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusBadge(status) {
            const colors = {
                'Finalizado': '#28a745',
                'Pendiente': '#ffc107',
                'Acordar': '#17a2b8'
            };
            const color = colors[status] || '#6c757d';
            return `<span style="background: ${color}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">${status}</span>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function filterStatus(status) {
            currentFilter = status;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(status.toLowerCase()) || 
                    (status === 'all' && btn.textContent === 'Todas')) {
                    btn.classList.add('active');
                }
            });
            // Re-render con filtro
            const productMap = new Map();
            salesData.forEach(p => {
                if (status !== 'all' && !p.orderStatus.includes(status)) return;
                const key = `${p.name}|${p.variety}|${p.weight}`;
                if (!productMap.has(key)) {
                    productMap.set(key, { ...p, totalQty: 0 });
                }
                productMap.get(key).totalQty += p.quantity;
            });
            renderTable(Array.from(productMap.values()));
        }

        function downloadCSV() {
            let csv = 'Producto,Variedad,Peso,Cantidad Total,SKU\n';
            const productMap = new Map();
            
            salesData.forEach(p => {
                const key = `${p.name}|${p.variety}|${p.weight}`;
                if (!productMap.has(key)) {
                    productMap.set(key, { ...p, totalQty: 0 });
                }
                productMap.get(key).totalQty += p.quantity;
            });

            Array.from(productMap.values()).forEach(p => {
                csv += `"${p.name}","${p.variety || ''}","${p.weight || ''}",${p.totalQty},"${p.sku || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `resumen_ventas_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
    </script>
</body>
</html>
